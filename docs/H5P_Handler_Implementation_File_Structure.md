# H5P CLI Creator - Handler Architecture Implementation Guide
## File Structure & Implementation Order

## Current h5p-cli-creator Structure (After Clone)

```
h5p-cli-creator/
â”œâ”€â”€ .git/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ node_modules/
â”œâ”€â”€ dist/                      # Compiled JavaScript (generated by npm run build)
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ src/                       # Current TypeScript source
â”‚   â”œâ”€â”€ index.ts              # Main CLI entry point âš ï¸ WILL MODIFY
â”‚   â”œâ”€â”€ Flashcards.ts         # âš ï¸ WILL BE REPLACED by FlashcardsHandler.ts
â”‚   â”œâ”€â”€ DialogCards.ts        # âš ï¸ WILL BE REPLACED by DialogCardsHandler.ts
â”‚   â”œâ”€â”€ H5pPackageBuilder.ts  # Keep as-is (package creation logic)
â”‚   â”œâ”€â”€ H5pImage.ts           # Keep as-is (image utilities)
â”‚   â”œâ”€â”€ H5pAudio.ts           # Keep as-is (audio utilities)
â”‚   â””â”€â”€ ... (other utility files)
â”œâ”€â”€ tests/                     # Test data
â”‚   â”œâ”€â”€ flash1.csv
â”‚   â”œâ”€â”€ dialog1.csv
â”‚   â””â”€â”€ ...
â””â”€â”€ templates/                 # H5P package templates
    â”œâ”€â”€ flashcards-template.h5p
    â””â”€â”€ dialogcards-template.h5p
```

---

## NEW File Structure (After Implementation)

```
h5p-cli-creator/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                              # âš ï¸ MODIFIED - New handler-based CLI
â”‚   â”‚
â”‚   â”œâ”€â”€ handlers/                             # âœ¨ NEW DIRECTORY - Handler Architecture
â”‚   â”‚   â”œâ”€â”€ ContentHandler.ts                 # âœ¨ NEW - Core interfaces
â”‚   â”‚   â”œâ”€â”€ HandlerRegistry.ts                # âœ¨ NEW - Registry implementation
â”‚   â”‚   â”œâ”€â”€ HandlerContextImpl.ts             # âœ¨ NEW - Context utilities
â”‚   â”‚   â”œâ”€â”€ SimpleLogger.ts                   # âœ¨ NEW - Logger implementation
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ FlashcardsHandler.ts              # âœ¨ NEW - Refactored from Flashcards.ts
â”‚   â”‚   â”œâ”€â”€ DialogCardsHandler.ts             # âœ¨ NEW - Refactored from DialogCards.ts
â”‚   â”‚   â””â”€â”€ InteractiveBookHandler.ts         # âœ¨ NEW - Your new handler
â”‚   â”‚
â”‚   â”œâ”€â”€ Flashcards.ts                         # ğŸ—‘ï¸ DEPRECATED - Keep for reference, remove later
â”‚   â”œâ”€â”€ DialogCards.ts                        # ğŸ—‘ï¸ DEPRECATED - Keep for reference, remove later
â”‚   â”œâ”€â”€ H5pPackageBuilder.ts                  # âœ… KEEP - Used by handlers
â”‚   â”œâ”€â”€ H5pImage.ts                           # âœ… KEEP - Used by handlers
â”‚   â””â”€â”€ H5pAudio.ts                           # âœ… KEEP - Used by handlers
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ handlers/                             # âœ¨ NEW DIRECTORY - Handler tests
â”‚   â”‚   â”œâ”€â”€ FlashcardsHandler.test.ts
â”‚   â”‚   â”œâ”€â”€ DialogCardsHandler.test.ts
â”‚   â”‚   â”œâ”€â”€ InteractiveBookHandler.test.ts
â”‚   â”‚   â””â”€â”€ HandlerRegistry.test.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ integration/                          # âœ¨ NEW DIRECTORY - Integration tests
â”‚   â”‚   â””â”€â”€ handler-workflow.test.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ flash1.csv                            # âœ… KEEP - Test data
â”‚   â”œâ”€â”€ dialog1.csv                           # âœ… KEEP - Test data
â”‚   â””â”€â”€ interactivebook1.csv                  # âœ¨ NEW - Test data for new handler
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ flashcards-template.h5p               # âœ… KEEP
â”‚   â”œâ”€â”€ dialogcards-template.h5p              # âœ… KEEP
â”‚   â””â”€â”€ interactivebook-template.h5p          # âœ¨ NEW - Template for Interactive Book
â”‚
â”œâ”€â”€ docs/                                      # âœ¨ NEW DIRECTORY - Documentation
â”‚   â”œâ”€â”€ HANDLER_DEVELOPMENT.md                # âœ¨ NEW - How to create handlers
â”‚   â”œâ”€â”€ CSV_FORMAT.md                         # âœ¨ NEW - Auto-generated CSV docs
â”‚   â””â”€â”€ MIGRATION.md                          # âœ¨ NEW - Migration guide
â”‚
â”œâ”€â”€ examples/                                  # âœ¨ NEW DIRECTORY - Example CSV files
â”‚   â”œâ”€â”€ flashcards-example.csv
â”‚   â”œâ”€â”€ dialogcards-example.csv
â”‚   â””â”€â”€ interactivebook-example.csv
â”‚
â”œâ”€â”€ package.json                               # âš ï¸ MODIFIED - Add jest, csv-parse deps
â”œâ”€â”€ tsconfig.json                              # âœ… KEEP (may need minor adjustments)
â”œâ”€â”€ jest.config.js                             # âœ¨ NEW - Jest test configuration
â””â”€â”€ README.md                                  # âš ï¸ MODIFIED - Update with handler info
```

---

## Step-by-Step Implementation Order

### Phase 1: Core Infrastructure (Do This First)

#### Step 1: Create handlers directory
```bash
cd h5p-cli-creator
mkdir -p src/handlers
```

#### Step 2: Add core interfaces
**File:** `src/handlers/ContentHandler.ts`
- Copy from design doc: "Core Interfaces" section (lines ~45-350)
- Contains: ContentHandler interface, ValidationResult, H5PContent, etc.

#### Step 3: Add logger
**File:** `src/handlers/SimpleLogger.ts`
- Copy from design doc: "Simple Logger Implementation" (lines ~900-920)
- Simple console-based logger

#### Step 4: Add registry
**File:** `src/handlers/HandlerRegistry.ts`
- Copy from design doc: "HandlerRegistry Class" (lines ~400-700)
- Manages handler registration and discovery

#### Step 5: Add context implementation
**File:** `src/handlers/HandlerContextImpl.ts`
- Copy from design doc: "HandlerContextImpl" (lines ~720-880)
- Provides utilities to handlers

### Phase 2: Refactor Existing Handlers

#### Step 6: Create Flashcards handler
**File:** `src/handlers/FlashcardsHandler.ts`
- Copy from design doc: "Flashcards Handler (Refactored)" (lines ~1500-1650)
- Migrates logic from old `Flashcards.ts`

#### Step 7: Create DialogCards handler
**File:** `src/handlers/DialogCardsHandler.ts`
- Copy from design doc: "Dialog Cards Handler (Refactored)" (lines ~1700-1850)
- Migrates logic from old `DialogCards.ts`

### Phase 3: Add New Handler

#### Step 8: Create Interactive Book handler
**File:** `src/handlers/InteractiveBookHandler.ts`
- Copy from design doc: "Interactive Book Handler (New)" (lines ~1100-1450)
- Your new content type!

### Phase 4: Update CLI

#### Step 9: Update main entry point
**File:** `src/index.ts` (REPLACE existing content)
- Copy from design doc: "Updated CLI Entry Point" (lines ~1900-2050)
- New handler-based CLI with dynamic commands

### Phase 5: Testing & Documentation

#### Step 10: Add tests
```bash
mkdir -p tests/handlers
mkdir -p tests/integration
```

**Files to create:**
- `tests/handlers/InteractiveBookHandler.test.ts` (copy from design doc)
- `tests/handlers/FlashcardsHandler.test.ts` (adapt from InteractiveBook)
- `tests/integration/handler-workflow.test.ts` (copy from design doc)

#### Step 11: Add documentation
```bash
mkdir -p docs
mkdir -p examples
```

**Files to create:**
- `docs/HANDLER_DEVELOPMENT.md` (copy from design doc)
- Generate `docs/CSV_FORMAT.md` using: `node ./dist/index.js docs`

#### Step 12: Add example CSVs
Create example files in `examples/` directory for each handler

### Phase 6: Dependencies & Configuration

#### Step 13: Update package.json
Add to dependencies:
```json
{
  "dependencies": {
    "csv-parse": "^5.5.0",
    "commander": "^11.0.0"  // (should already exist)
  },
  "devDependencies": {
    "@types/jest": "^29.5.0",
    "jest": "^29.5.0",
    "ts-jest": "^29.1.0"
  }
}
```

#### Step 14: Create jest.config.js
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
  ],
};
```

#### Step 15: Install dependencies
```bash
npm install
```

---

## Implementation Checklist

### Week 1: Core Infrastructure âœ…

- [ ] Clone h5p-cli-creator repository
- [ ] Create `src/handlers/` directory
- [ ] Add `ContentHandler.ts` (interfaces)
- [ ] Add `SimpleLogger.ts` (logger)
- [ ] Add `HandlerRegistry.ts` (registry)
- [ ] Add `HandlerContextImpl.ts` (context)
- [ ] Verify TypeScript compilation: `npm run build`

### Week 2: Refactor Existing + Add New âœ…

- [ ] Add `FlashcardsHandler.ts`
- [ ] Add `DialogCardsHandler.ts`
- [ ] Add `InteractiveBookHandler.ts`
- [ ] Update `src/index.ts` with new CLI
- [ ] Keep old `Flashcards.ts` and `DialogCards.ts` for reference
- [ ] Create `templates/interactivebook-template.h5p` (create sample in H5P editor)
- [ ] Test compilation: `npm run build`

### Week 3: Testing & Documentation âœ…

- [ ] Create test directories (`tests/handlers/`, `tests/integration/`)
- [ ] Add handler unit tests
- [ ] Add integration tests
- [ ] Update `package.json` with jest dependencies
- [ ] Create `jest.config.js`
- [ ] Run tests: `npm test`
- [ ] Create `docs/` directory
- [ ] Add `HANDLER_DEVELOPMENT.md`
- [ ] Generate CSV docs: `node ./dist/index.js docs`
- [ ] Create example CSVs in `examples/`
- [ ] Update README.md

### Week 4: Polish & PR âœ…

- [ ] Test all three content types:
  - [ ] `node ./dist/index.js flashcards ./tests/flash1.csv ./output1.h5p`
  - [ ] `node ./dist/index.js dialogcards ./tests/dialog1.csv ./output2.h5p`
  - [ ] `node ./dist/index.js interactivebook ./tests/interactivebook1.csv ./output3.h5p`
- [ ] Verify backward compatibility (old commands still work)
- [ ] Update CHANGELOG.md
- [ ] Create comprehensive PR description
- [ ] Submit pull request
- [ ] Respond to maintainer feedback

---

## Quick Start Commands

### Initial Setup
```bash
# Clone the repository
git clone https://github.com/sr258/h5p-cli-creator.git
cd h5p-cli-creator

# Install dependencies
npm install

# Create new directories
mkdir -p src/handlers
mkdir -p tests/handlers
mkdir -p tests/integration
mkdir -p docs
mkdir -p examples

# Build to verify everything compiles
npm run build
```

### After Adding Handler Files
```bash
# Compile TypeScript
npm run build

# Test a handler
node ./dist/index.js flashcards ./tests/flash1.csv ./test-output.h5p

# Generate documentation
node ./dist/index.js docs

# List available handlers
node ./dist/index.js list

# Generate CSV template
node ./dist/index.js template interactivebook -o ./examples/interactivebook-template.csv

# Run tests (after adding jest)
npm test
```

---

## File-by-File Code Mapping

### From Design Doc â†’ Your Files

| Design Doc Section | Your File Path | Lines in Doc |
|-------------------|----------------|--------------|
| Core Interfaces | `src/handlers/ContentHandler.ts` | ~45-350 |
| HandlerRegistry | `src/handlers/HandlerRegistry.ts` | ~400-700 |
| HandlerContext | `src/handlers/HandlerContextImpl.ts` | ~720-880 |
| SimpleLogger | `src/handlers/SimpleLogger.ts` | ~900-920 |
| Interactive Book | `src/handlers/InteractiveBookHandler.ts` | ~1100-1450 |
| Flashcards Handler | `src/handlers/FlashcardsHandler.ts` | ~1500-1650 |
| Dialog Cards Handler | `src/handlers/DialogCardsHandler.ts` | ~1700-1850 |
| CLI Integration | `src/index.ts` (replace) | ~1900-2050 |
| Unit Tests | `tests/handlers/InteractiveBookHandler.test.ts` | ~2100-2200 |
| Integration Tests | `tests/integration/handler-workflow.test.ts` | ~2250-2350 |
| Handler Dev Guide | `docs/HANDLER_DEVELOPMENT.md` | ~2400-2500 |

---

## Tips for Success

### 1. **Start Small, Test Often**
```bash
# After adding each file, rebuild and check for errors
npm run build

# Look for TypeScript errors
# Fix imports before moving to next file
```

### 2. **Keep Old Files Initially**
Don't delete `Flashcards.ts` and `DialogCards.ts` right away:
- Keep them for reference during refactoring
- Verify new handlers produce identical output
- Remove after successful testing

### 3. **Import Paths**
When copying code, update imports:
```typescript
// In handlers, use relative imports:
import { ContentHandler } from './ContentHandler';
import { HandlerContext } from './ContentHandler';

// From index.ts, import from handlers directory:
import { HandlerRegistry } from './handlers/HandlerRegistry';
import { FlashcardsHandler } from './handlers/FlashcardsHandler';
```

### 4. **Dependencies**
Add these to package.json before starting:
```json
{
  "dependencies": {
    "csv-parse": "^5.5.0"
  }
}
```

Then: `npm install`

### 5. **TypeScript Configuration**
Your existing `tsconfig.json` should work, but ensure:
```json
{
  "compilerOptions": {
    "target": "ES2019",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true
  }
}
```

---

## Common Issues & Solutions

### Issue 1: Import Errors
**Error:** `Cannot find module './ContentHandler'`

**Solution:** Check file exists and path is correct
```typescript
// Make sure ContentHandler.ts exists in same directory
import { ContentHandler } from './ContentHandler'; // âœ… Correct
import { ContentHandler } from '../ContentHandler'; // âŒ Wrong if in handlers/
```

### Issue 2: H5pPackageBuilder Not Found
**Error:** `Cannot find module '../H5pPackageBuilder'`

**Solution:** Update import path in index.ts
```typescript
// Old code uses H5pPackageBuilder from same directory
import { H5pPackageBuilder } from './H5pPackageBuilder'; // âœ… Correct
```

### Issue 3: CSV Parse Not Found
**Error:** `Cannot find module 'csv-parse/sync'`

**Solution:** Install dependency
```bash
npm install csv-parse
```

### Issue 4: Tests Not Running
**Error:** `jest: command not found`

**Solution:** Install jest and add test script
```bash
npm install --save-dev jest ts-jest @types/jest
```

Add to package.json:
```json
{
  "scripts": {
    "test": "jest"
  }
}
```

---

## Validation Commands

### After Each Phase, Run:

```bash
# Phase 1: Core infrastructure
npm run build
# Should compile without errors

# Phase 2: Handlers
npm run build
node ./dist/index.js list
# Should show all three content types

# Phase 3: Testing
npm test
# All tests should pass

# Phase 4: End-to-end
node ./dist/index.js flashcards ./tests/flash1.csv ./output1.h5p
node ./dist/index.js dialogcards ./tests/dialog1.csv ./output2.h5p
node ./dist/index.js interactivebook ./examples/interactivebook-example.csv ./output3.h5p
# All three should generate valid .h5p files
```

---

## Success Criteria

âœ… **Phase 1 Complete When:**
- All 5 core files compile without errors
- `npm run build` succeeds
- No TypeScript errors

âœ… **Phase 2 Complete When:**
- All 3 handlers compile without errors
- `node ./dist/index.js list` shows all content types
- Old commands still work (backward compatibility)

âœ… **Phase 3 Complete When:**
- All tests pass (`npm test`)
- Documentation generated successfully
- Example CSVs created

âœ… **Phase 4 Complete When:**
- All three content types generate valid .h5p files
- Files can be uploaded to H5P test site
- PR is ready for submission

---

## Your Next Steps

1. **Clone the repository:**
   ```bash
   git clone https://github.com/sr258/h5p-cli-creator.git
   cd h5p-cli-creator
   npm install
   ```

2. **Create the handlers directory:**
   ```bash
   mkdir -p src/handlers
   ```

3. **Open your design doc** and start copying code section by section

4. **Follow the checklist above**, testing after each file

5. **Come back if you hit any snags** - I'm here to help debug!

Good luck! You've got a solid plan and complete code to work with. This should be a smooth implementation! ğŸš€
